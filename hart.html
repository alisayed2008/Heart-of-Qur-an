<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø®Ø±ÙŠØ·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† â€” Ø§Ù„Ù‚Ù„Ø¨</title>
<link rel="icon" type="image/x-icon" href="hart.ico">
<link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #ffffff;
    --accent: #ff4d4d;
    --accent-strong: #e60000;
    --muted: #6b7280;
    --shadow: 0 12px 40px rgba(2,6,23,0.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'El Messiri',sans-serif;background:var(--bg);color:#071133}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;}
  .panel{width:100%;max-width:1200px;border-radius:16px;background:linear-gradient(180deg,#fff,#fcfdff);box-shadow:var(--shadow);display:flex;gap:20px;padding:18px;}
  .card{flex:0 0 68%;padding:14px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid #eef4fb;min-width:320px}
  .card-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .title{font-size:18px;font-weight:700}
  .sub{color:var(--muted);font-size:13px}
  .heart-container{background:linear-gradient(180deg,#fff,#f7fbff);padding:12px;border-radius:12px;border:1px solid #eef6fc;display:flex;align-items:center;justify-content:center;min-height:380px}
  svg{max-width:100%;height:auto;display:block;user-select:none;-webkit-user-select:none}

  /* ---------- stroke black always, fill only when revealed ---------- */
  .segment{
    fill: #676767e6 !important;      /* interior empty from start */
    stroke: #000 !important;           /* black outlines always */
    stroke-width: 1.6 !important;
    cursor: pointer;
    transition: transform .18s ease, filter .18s ease, fill .25s ease;
  }
  .segment:hover{transform:translateY(-4px);filter:drop-shadow(0 10px 20px rgba(3,7,18,0.06))}
  .segment.revealed{
    fill: var(--accent) !important;    /* red fill only when revealed */
    stroke: #000 !important;           /* outline remains black */
  }

  .overlay-draw{pointer-events:none; fill:none; stroke:var(--accent); stroke-width:2.6; stroke-linecap:round; stroke-linejoin:round;}

  .outline{fill:none;stroke:#000;stroke-width:1.6;pointer-events:none}
  svg text.segment-label{font-size:10px;font-weight:600;fill:#071133;pointer-events:none;text-anchor:middle;dominant-baseline:central;font-family:'El Messiri',sans-serif}
  svg text.segment-label.revealed{fill:#ffffff}

  /* sidebar */
  .sidebar{flex:1;min-width:260px;display:flex;flex-direction:column;gap:12px}
  .panel-block{background:#fff;padding:12px;border-radius:10px;border:1px solid #f0f6fb;box-shadow:0 6px 18px rgba(12,15,35,0.03)}
  .progress-bar{height:12px;background:#eef6fb;border-radius:8px;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-strong));width:0%;transition:width .6s ease}
  .big-num{font-weight:700;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .controls .left { margin-right:auto; display:flex; gap:8px; align-items:center; }
  button.btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;box-shadow:0 8px 20px rgba(255,77,77,0.14)}
  button.ghost{background:transparent;border:1px solid #e6eef7;color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer}

  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:white;padding:18px;border-radius:12px;min-width:320px;box-shadow:0 18px 60px rgba(2,6,23,0.25)}
  .modal h3{margin:0 0 8px}
  .modal p{margin:0 0 14px;color:var(--muted)}
  .modal .row{display:flex;gap:10px;justify-content:flex-end}

  footer.note{font-size:13px;color:var(--muted);margin-top:8px}
  /* Celebration overlay */
  #celebrate{display:none;position:fixed;inset:0;z-index:120;pointer-events:none}
  #celebrate .back{position:absolute;inset:0;background:rgba(0,0,0,0.45);backdrop-filter: blur(2px)}
  #celebrate .center{position:absolute;left:50%;top:12%;transform:translateX(-50%);text-align:center;color:#fff;pointer-events:auto}
  #celebrate h2{font-size:34px;margin:0 0 8px}
  #celebrate p{margin:0 0 12px}
  #balloons > div{position:absolute;bottom:-80px;width:28px;height:36px;border-radius:50% 50% 45% 45%;box-shadow:0 8px 20px rgba(0,0,0,.18);animation:balloon-float linear infinite}
  @keyframes balloon-float { 0%{transform:translateY(20vh) scale(.9);opacity:0} 10%{opacity:1} 100%{transform:translateY(-110vh) scale(1.05);opacity:.95} }
  .dot{position:absolute;width:10px;height:10px;border-radius:50%;box-shadow:0 0 18px currentColor,0 0 36px currentColor;animation:twinkle 1.6s ease-in-out infinite}
  @keyframes twinkle {0%,100%{opacity:.25;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}

  /* Share modal */
  #share-modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:130;background:rgba(0,0,0,0.45)}
  #share-box{background:white;padding:16px;border-radius:12px;min-width:320px;max-width:420px}

  /* responsive */
  @media (max-width:980px){.panel{flex-direction:column}.card{width:100%}.controls{justify-content:flex-start}}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="card">
      <div class="card-header">
        <div>
          <div class="title">Ø®Ø±ÙŠØ·Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† â€” Ø§Ù„Ù‚Ù„Ø¨</div>
          <div class="sub">Ø§Ø¶ØºØ· Ø£ÙŠ Ø¬Ø²Ø¡ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸. Ø§Ù„ØªÙ‚Ø¯Ù… ÙŠÙØ®Ø²Ù‘Ù† Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</div>
        </div>
        <div class="controls" role="toolbar" aria-label="controls">
          <div class="left">
            <button class="ghost" id="btn-list" title="Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©">Ù‚Ø§Ø¦Ù…Ø©</button>
            <button class="ghost" id="btn-share" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø¯Ù…" style="display:none">Ø´Ø§Ø±Ùƒ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
          </div>
          <button class="btn" id="btn-reset" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯Ù…">Ø¥Ø¹Ø§Ø¯Ø©</button>
        </div>
      </div>

      <div class="heart-container" id="heart-wrap">
        <div id="svg-loader" class="muted">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù„Ø¨â€¦</div>
      </div>

      <footer class="note">Ø³Ø¬Ù„ ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ø­ÙØ¸ ÙƒØªØ§Ø¨ Ø§Ù„Ù„Ù‡ Ø¹Ù† Ø·Ø±ÙŠÙ‚ ØªØ¸Ù„ÙŠÙ„ Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ù„Ø¨ ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ù…Ø¹ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</footer>
    </div>

    <aside class="sidebar">
      <div class="panel-block">
        <div class="muted">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
          <div class="big-num" id="count-text">0 / 0</div>
          <div class="muted" id="last-text">Ù„Ø§ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸</div>
        </div>
        <div style="margin-top:12px" class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
      </div>

      <div class="panel-block">
        <div class="muted">Ø±Ø³Ø§Ø¦Ù„ ØªØ´Ø¬ÙŠØ¹</div>
        <div style="margin-top:10px;font-weight:600" id="encourage">Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ… â€” Ø®Ø·ÙˆØ© Ø®Ø·ÙˆØ© ğŸŒ¿</div>
      </div>

      <div class="panel-block">
        <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <ul style="margin:10px 0 0 18px;color:var(--muted);font-size:14px">
          <li>Ø§Ø¶ØºØ· Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙˆØ±Ø© Ù„ØªØ¸Ù„Ù„Ù‡Ø§</li>
          <li>ØªÙ‚Ø¯Ù…Ùƒ ÙŠØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ</li>
          <li>Ø§Ø¶ØºØ· <a href="https://zuolfa.com/%D8%AD%D9%81%D8%B8-%D8%A7%D9%84%D9%82%D8%B1%D8%A2%D9%86-%D8%A3%D9%87%D9%85%D9%8A%D8%AA%D9%87-%D9%8810-%D9%85%D8%B2%D8%A7%D9%8A%D8%A7-%D9%84%D8%AD%D8%A7%D9%81%D8%B8-%D8%A7%D9%84%D9%82%D8%B1%D8%A2%D9%86/" target="_blank">Ù‡Ù†Ø§</a> Ù„Ù…Ø¹Ø±ÙØ© Ø§ÙØ¶Ø§Ù„ Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</li>
        </ul>
      </div>
       <div class="panel-block">
  <button class="btn" onclick="window.location.href='https://buymeacoffee.com/heartquran'">
     ØªØ¨Ø±Ø¹ Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹
  </button>
</div>

</div>

        </div>
    </aside>
  </div>
</div>

<!-- Modal Confirm -->
<div id="modal" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog">
    <h3 id="modal-title">ØªØ£ÙƒÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­ÙØ¸</h3>
    <p id="modal-body">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØªÙ…Ø§Ù… Ø­ÙØ¸ Ø³ÙˆØ±Ø© ...ØŸ</p>
    <div class="row">
      <button class="ghost" id="modal-cancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn" id="modal-confirm">Ù…ØªØ£ÙƒØ¯</button>
    </div>
  </div>
</div>

<!-- Celebration overlay -->
<div id="celebrate" aria-hidden="true">
  <div class="back"></div>
  <div class="center" role="status" aria-live="polite">
    <h2>Ù…Ø¨Ø±ÙˆÙƒ! Ø®ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø¢Ù† ğŸ‰</h2>
    <p>Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡ â€” Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠ Ø­ÙØ¸Ùƒ!</p>
    <div style="margin-top:12px;">
      <button id="celebration-close" class="btn">Ø£ØºÙ„Ù‚</button>
    </div>
  </div>
  <div id="confetti-area" aria-hidden="true"></div>
  <div id="balloons" aria-hidden="true"></div>
  <div id="lights" aria-hidden="true"></div>
</div>

<!-- Share modal -->
<div id="share-modal" aria-hidden="true">
  <div id="share-box" role="dialog" aria-modal="true">
    <h3>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªÙ‚Ø¯Ù…</h3>
    <p class="muted">Ø§Ø®ØªØ± ÙƒÙŠÙ ØªØ´Ø§Ø±Ùƒ â€” Ø£Ù†ØµØ­ Ø¨Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px">
      <button class="ghost" id="share-wasap">Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø¢Ø¨</button>
      <button class="ghost" id="share-fb">Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠØ³ Ø¨ÙˆÙƒ</button>
      <button class="btn" id="share-direct">Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¨Ø§Ø´Ø±Ø© / Ø­ÙØ¸</button>
      <button class="ghost" id="share-copy">Ù†Ø³Ø® Ù„Ù„ØµÙˆØ±Ø©</button>
    </div>
    <div style="margin-top:12px;text-align:left;font-size:13px;color:var(--muted)">
      <div id="share-status"></div>
    </div>
    <div style="text-align:right;margin-top:10px"><button id="share-close" class="ghost">Ø¥ØºÙ„Ø§Ù‚</button></div>
  </div>
</div>

<script>
const SVG_FILE = 'heart_segments_named.svg'; 

// DOM refs
const heartWrap = document.getElementById('heart-wrap');
const loader = document.getElementById('svg-loader');
const modalEl = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');
const modalCancel = document.getElementById('modal-cancel');
const modalConfirm = document.getElementById('modal-confirm');
const progressFill = document.getElementById('progress-fill');
const countText = document.getElementById('count-text');
const lastText = document.getElementById('last-text');
const encourage = document.getElementById('encourage');
const btnReset = document.getElementById('btn-reset');
const btnList = document.getElementById('btn-list');
const btnShare = document.getElementById('btn-share');

const celebrate = document.getElementById('celebrate');
const confettiArea = document.getElementById('confetti-area');
const balloons = document.getElementById('balloons');
const lights = document.getElementById('lights');
const celebrationClose = document.getElementById('celebration-close');

const shareModal = document.getElementById('share-modal');
const shareClose = document.getElementById('share-close');
const shareWasap = document.getElementById('share-wasap');
const shareFb = document.getElementById('share-fb');
const shareDirect = document.getElementById('share-direct');
const shareCopy = document.getElementById('share-copy');
const shareStatus = document.getElementById('share-status');

let segments = [];
let saved = JSON.parse(localStorage.getItem('quran_heart_progress') || '{}') || {};
if (!saved || typeof saved !== 'object') saved = {};

// Helper: load & inject svg (keeps your structure)
async function loadAndInjectSVG(){
  try{
    const res = await fetch(SVG_FILE);
    if(!res.ok) throw new Error('SVG not found: ' + res.status);
    const text = await res.text();
    heartWrap.innerHTML = text;
    segments = Array.from(heartWrap.querySelectorAll('.segment'));
    loader && loader.remove();
    initializeSegments();
    const svgRoot = heartWrap.querySelector('svg');
    if(svgRoot) setTimeout(()=>createOutlinesAndLabels(svgRoot), 120);
    updateUI();
  } catch(err){
    console.error(err);
    if(loader) loader.innerText = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ' + err.message;
  }
}

function updateUI(){
  const total = segments.length;
  const done = Object.keys(saved).filter(k => k !== '_last' && k !== '_celebrated').length;
  countText.textContent = `${done} / ${total}`;
  lastText.textContent = saved._last ? `Ø¢Ø®Ø±: ${saved._last}` : 'Ù„Ø§ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸';
  progressFill.style.width = total ? `${Math.round((done/total)*100)}%` : '0%';
  // show share button if at least one saved
  btnShare.style.display = done > 0 ? 'inline-block' : 'none';
  // check completion
  if(total && done === total && !saved._celebrated){
    saved._celebrated = true;
    localStorage.setItem('quran_heart_progress', JSON.stringify(saved));
    showCelebration();
  }
}

function initializeSegments(){
  if(!segments.length){
    heartWrap.querySelector('#svg-loader')?.remove();
    heartWrap.insertAdjacentHTML('beforeend','<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø·Ø¹ (segments) ÙÙŠ Ø§Ù„Ù€SVG</div>');
    return;
  }

  segments.forEach(seg=>{
    const name = seg.getAttribute('data-name') || seg.getAttribute('id') || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

    // Force outlines and empty fill from the start (do not change structure)
    seg.setAttribute('fill','transparent');
    seg.setAttribute('stroke', seg.getAttribute('stroke') || '#000');
    seg.style.cursor = 'pointer';

    if(saved[name]){
      seg.classList.add('revealed');
    }

    try{
      const len = seg.getTotalLength();
      seg.style.strokeDasharray = len;
      seg.style.strokeDashoffset = len;
      seg.dataset._len = len;
    } catch(e){}

    seg.addEventListener('click', (e)=>{
      e.preventDefault();
      if(saved[name]) {
        encourage.textContent = `Ù„Ù‚Ø¯ Ø³Ø¨Ù‚ Ø­ÙØ¸ "${name}".`;
        return;
      }
      modalTitle.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­ÙØ¸';
      modalBody.textContent = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØªÙ…Ø§Ù… Ø­ÙØ¸ Ø³ÙˆØ±Ø© "${name}"ØŸ`;
      modalEl.style.display = 'flex';
      modalEl.dataset.target = name;
    });
  });
}

/* outlines and labels (keeps your existing flow) */
function createOutlinesAndLabels(svgRoot){
  try{
    const existingOut = svgRoot.querySelector('#__outlines_group');
    if(existingOut) existingOut.remove();
    const outlinesG = document.createElementNS('http://www.w3.org/2000/svg','g');
    outlinesG.setAttribute('id','__outlines_group');
    const labelsG = document.createElementNS('http://www.w3.org/2000/svg','g');
    labelsG.setAttribute('id','__labels_group');

    segments.forEach(seg=>{
      try{
        const clone = seg.cloneNode(false);
        clone.classList.remove('segment');
        clone.classList.add('outline');
        clone.setAttribute('fill','#515151e8');
        clone.setAttribute('stroke','#000');
        clone.setAttribute('stroke-width','1.6');
        clone.style.pointerEvents = 'none';
        outlinesG.appendChild(clone);

        const name = seg.getAttribute('data-name') || seg.getAttribute('id') || '';
        let cx = 0, cy = 0;
        let bb = null;
        try{ bb = seg.getBBox(); cx = bb.x + bb.width/2; cy = bb.y + bb.height/2; } catch(e){
          const sbb = svgRoot.getBBox(); cx = sbb.width/2; cy = sbb.height/2;
        }
        const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('class','segment-label');
        txt.setAttribute('x',cx);
        txt.setAttribute('y',cy);
        txt.textContent = name;
        try{ const size = Math.max(8, Math.min(14, Math.round(Math.min(bb.width, bb.height) * 0.18))); txt.style.fontSize = size + 'px'; }catch(e){}
        labelsG.appendChild(txt);
      }catch(err){
        console.warn('outline/label err',err);
      }
    });

    svgRoot.appendChild(outlinesG);
    svgRoot.appendChild(labelsG);

    segments.forEach((s,i)=>{
      const name = s.getAttribute('data-name') || s.getAttribute('id') || '';
      const label = labelsG.children[i];
      if(!label) return;
      if(saved[name]) label.classList.add('revealed');
    });

  }catch(e){ console.warn('createOutlinesAndLabels failed',e); }
}

/* ---------- drawing overlay + reveal (keeps outlines visible) ---------- */
function animateDrawThenReveal(seg, name, onDone){
  const svgRoot = heartWrap.querySelector('svg');
  if(!svgRoot){
    seg.classList.add('revealed'); if(typeof onDone==='function') onDone(); return;
  }
  try{
    const overlay = seg.cloneNode(false);
    overlay.classList.add('overlay-draw');
    overlay.setAttribute('fill','none');
    overlay.setAttribute('stroke', 'var(--accent)');
    overlay.setAttribute('stroke-width','2.6');
    let len = 0;
    try{ len = overlay.getTotalLength(); }catch(e){ len = seg.dataset._len || 0; }
    overlay.style.strokeDasharray = len;
    overlay.style.strokeDashoffset = len;
    overlay.style.transition = 'stroke-dashoffset 0.45s linear';
    // insert before outlines group so outlines remain on top
    const outlinesG = svgRoot.querySelector('#__outlines_group');
    if(outlinesG) svgRoot.insertBefore(overlay, outlinesG);
    else svgRoot.appendChild(overlay);
    void overlay.getBoundingClientRect();
    requestAnimationFrame(()=> overlay.style.strokeDashoffset = '0');
    const handler = function(ev){
      if(ev && ev.propertyName && ev.propertyName !== 'stroke-dashoffset' && ev.propertyName !== 'strokeDashoffset') return;
      overlay.removeEventListener('transitionend', handler);
      try{ overlay.remove(); }catch(e){}
      seg.classList.add('revealed');
      if(typeof onDone==='function') onDone();
    };
    overlay.addEventListener('transitionend', handler);
    setTimeout(()=> {
      if(svgRoot.contains(overlay)){
        try{ overlay.remove(); }catch(e){}
        seg.classList.add('revealed');
        if(typeof onDone==='function') onDone();
      }
    }, 900);
  } catch(e){
    seg.classList.add('revealed'); if(typeof onDone==='function') onDone();
  }
}

/* ===== Celebration visuals ===== */
function createConfetti(areaEl, count=200){
  areaEl.innerHTML = '';
  const style = document.createElement('style');
  style.textContent = `@keyframes confetti-fall {0%{transform:translateY(-10vh) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:.9}}`;
  document.head.appendChild(style);
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    const size = 6 + Math.random()*8;
    p.style.position='absolute';
    p.style.left = (Math.random()*100)+'%';
    p.style.top = (Math.random()*60)+'%';
    p.style.width = size+'px';
    p.style.height = size+'px';
    p.style.background = `hsl(${Math.floor(Math.random()*360)},90%,55%)`;
    p.style.transform = `rotate(${Math.random()*360}deg)`;
    p.style.borderRadius = '2px';
    p.style.opacity = '0.95';
    const dur = 2 + Math.random()*2.5;
    p.style.animation = `confetti-fall ${dur}s linear ${Math.random()*1}s forwards`;
    p.style.zIndex='125';
    areaEl.appendChild(p);
  }
}
function createBalloons(container, n=12){
  container.innerHTML = '';
  for(let i=0;i<n;i++){
    const b = document.createElement('div');
    const hue = Math.floor(Math.random()*360);
    const left = Math.random()*100;
    const d = 8 + Math.random()*6;
    const delay = Math.random()*3;
    b.style.left = left+'%';
    b.style.width = 26 + Math.random()*20 + 'px';
    b.style.height = 34 + Math.random()*22 + 'px';
    b.style.background = `hsl(${hue},90%,55%)`;
    b.style.borderRadius = '50% 50% 45% 45%';
    b.style.position = 'absolute';
    b.style.bottom = '-80px';
    b.style.boxShadow = '0 8px 20px rgba(0,0,0,.18)';
    b.style.animation = `balloon-float ${d}s linear ${delay}s infinite`;
    container.appendChild(b);
  }
}
function createLights(container, n=30){
  container.innerHTML = '';
  for(let i=0;i<n;i++){
    const dot = document.createElement('div');
    dot.className='dot';
    const hue = Math.floor(Math.random()*360);
    dot.style.color = `hsl(${hue},95%,60%)`;
    dot.style.left = (Math.random()*100) + '%';
    dot.style.top = (Math.random()*100) + '%';
    dot.style.animationDuration = (0.8 + Math.random()*1.6) + 's';
    container.appendChild(dot);
  }
}
function showCelebration(){
  createConfetti(confettiArea, 180);
  createBalloons(balloons, 14);
  createLights(lights, 28);
  celebrate.style.display = 'block';
  celebrate.setAttribute('aria-hidden','false');
  celebrate.style.pointerEvents = 'auto';
  // auto close after 12s
  setTimeout(()=> {
    celebrationClose.focus && celebrationClose.focus();
  }, 300);
}
celebrationClose.addEventListener('click', ()=> {
  celebrate.style.display='none';
  celebrate.setAttribute('aria-hidden','true');
  confettiArea.innerHTML=''; balloons.innerHTML=''; lights.innerHTML='';
});

/* ===== Modal handlers (existing flow) ===== */
modalCancel.addEventListener('click', ()=>{ modalEl.style.display='none'; modalEl.dataset.target=''; });

modalConfirm.addEventListener('click', ()=>{
  const name = modalEl.dataset.target;
  if(!name) return modalEl.style.display='none';
  const seg = segments.find(s => (s.getAttribute('data-name') || s.getAttribute('id')) === name);
  if(!seg){ modalEl.style.display='none'; return; }

  // Special-case: Ø§Ù„ÙØ§ØªØ­Ø© â€” ØªØ³Ø¬Ù„ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¯ÙˆÙ† ØªÙ„ÙˆÙŠÙ† (ØªØ¬Ù†ÙØ¨ Ù„Ø£Ù† Ø§Ù„ÙØ§ØªØ­Ø© Ù‚Ø¯ ØªÙ…Ø«Ù„ Ù…Ø³Ø§Ø±Ø§Ù‹ ÙŠØºØ·ÙŠ Ø§Ù„Ù‚Ù„Ø¨ ÙƒÙ„Ù‡)
  if(name === 'Ø§Ù„ÙØ§ØªØ­Ø©'){
    saved[name] = true;
    saved._last = name;
    localStorage.setItem('quran_heart_progress', JSON.stringify(saved));
    updateUI();
    encourage.textContent = `Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ (ØºÙŠØ± Ù…Ù„ÙˆÙ†Ø© Ù„ØªØ¬Ù†Ø¨ ØªØºØ·ÙŠØ© Ø§Ù„Ù‚Ù„Ø¨).`;
    modalEl.style.display = 'none';
    return;
  }

  try{
    animateDrawThenReveal(seg, name, () => {
      saved[name] = true;
      saved._last = name;
      localStorage.setItem('quran_heart_progress', JSON.stringify(saved));
      updateUI();
      const svgRoot = heartWrap.querySelector('svg');
      if(svgRoot){
        const labelsG = svgRoot.querySelector('#__labels_group');
        if(labelsG){
          for(let i=0;i<labelsG.children.length;i++){
            const lab = labelsG.children[i];
            if(lab && (lab.textContent || '').trim() === name) lab.classList.add('revealed');
          }
        }
      }
      encourage.textContent = `Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! ØªÙ… Ø­ÙØ¸ "${name}". Ø§Ø³ØªÙ…Ø± ğŸŒŸ`;
      modalEl.style.display = 'none';
    });
  } catch(e){
    seg.classList.add('revealed');
    saved[name] = true;
    saved._last = name;
    localStorage.setItem('quran_heart_progress', JSON.stringify(saved));
    updateUI();
    encourage.textContent = `Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! ØªÙ… Ø­ÙØ¸ "${name}". Ø§Ø³ØªÙ…Ø± ğŸŒŸ`;
    modalEl.style.display = 'none';
  }
});

/* reset */
btnReset.addEventListener('click', ()=>{
  const ok = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø®Ø²Ù† Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.');
  if(!ok) return;
  localStorage.removeItem('quran_heart_progress');
  saved = {};
  segments.forEach(s => s.classList.remove('revealed'));
  const svgRoot = heartWrap.querySelector('svg');
  if(svgRoot){
    const labelsG = svgRoot.querySelector('#__labels_group');
    if(labelsG) for(let i=0;i<labelsG.children.length;i++) labelsG.children[i].classList.remove('revealed');
  }
  updateUI();
  encourage.textContent = 'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„ Ø´ÙŠØ¡ â€” Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸŒ±';
});

/* list */
btnList.addEventListener('click', ()=>{
  const done = Object.keys(saved).filter(k=>k!=='_last' && k!=='_celebrated');
  if(done.length === 0) return alert('Ù„Ù… ØªØ­ÙØ¸ Ø£ÙŠ Ø³ÙˆØ±Ø© Ø¨Ø¹Ø¯.');
  alert(`Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (${done.length}):\n` + done.join(', '));
});

/* ====== SHARE: generate PNG from SVG, then share/download/copy ====== */
async function svgToPngBlob(svgEl, scale=2){
  // clone and prepare
  const clone = svgEl.cloneNode(true);
  // remove overlay-draw (if any), keep outlines
  clone.querySelectorAll('.overlay-draw').forEach(n=>n.remove());
  // inline styles: ensure segments have fill/stroke attributes so serialization matches visuals
  const segs = clone.querySelectorAll('.segment');
  segs.forEach(s=>{
    const name = s.getAttribute('data-name') || s.getAttribute('id');
    const isRevealed = Boolean(saved[name]);
    s.setAttribute('stroke','#000');
s.setAttribute('fill', isRevealed ? '#ff4d4d' : '#ffffff00');
  });
  // also ensure outline group is present; labels will be kept
  // serialize
  const svgString = new XMLSerializer().serializeToString(clone);
  const encoded = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgString);
  const img = new Image();
  img.src = encoded;
  await new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; });
  const width = img.width * scale;
  const height = img.height * scale;
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff00'; // transparent background
  ctx.fillRect(0,0,width,height);
  ctx.drawImage(img, 0, 0, width, height);
  return new Promise((resolve)=> canvas.toBlob(resolve, 'image/png'));
}

async function shareProgressAsImage(){
  const svgRoot = heartWrap.querySelector('svg');
  if(!svgRoot) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ù„Ø¨ Ù„Ù„ØªØ­ÙˆÙŠÙ„.');
  shareStatus.textContent = 'Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø©...';
  try{
    const blob = await svgToPngBlob(svgRoot, 2);
    if(!blob) throw new Error('Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©');
    // try Web Share API with files
    const file = new File([blob], 'quran-progress.png', { type: 'image/png' });
    if(navigator.canShare && navigator.canShare({ files: [file] })){
      try {
        await navigator.share({ files: [file], title: 'ØªÙ‚Ø¯Ù‘Ù… Ø­ÙØ¸ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†', text: 'Ù‡Ø°Ø§ ØªÙ‚Ø¯Ù‘Ù…ÙŠ ÙÙŠ Ø­ÙØ¸ Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† â€” Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡' });
        shareStatus.textContent = 'ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.';
        shareModal.style.display='none';
        return;
      } catch (err) {
        // fallthrough to other options
        console.warn('share failed', err);
      }
    }
    // try copy to clipboard (image)
    if(navigator.clipboard && navigator.clipboard.write){
      try{
        await navigator.clipboard.write([ new ClipboardItem({ "image/png": blob }) ]);
        shareStatus.textContent = 'Ù†Ø³Ø®Øª Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© â€” Ø§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ùˆ Ù‚Ù… Ø¨Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù…Ù†Ø´ÙˆØ±.';
      } catch(err){ console.warn('clipboard write failed', err); shareStatus.textContent = 'Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© ÙØ´Ù„.'; }
    }
    // provide download link as fallback
    const url = URL.createObjectURL(blob);
    // set download by opening new tab or providing link
    shareStatus.innerHTML = `Ø§Ù„ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø©. <a href="${url}" download="quran-progress.png">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªØ­Ù…ÙŠÙ„Ù‡Ø§</a> â€” Ø«Ù… Ø´Ø§Ø±ÙƒÙ‡Ø§ Ø¹Ù„Ù‰ ÙÙŠØ³Ø¨ÙˆÙƒ/ÙˆØ§ØªØ³Ø§Ø¨.`;
    // open WhatsApp web with a message (user must attach image manually if desktop)
    shareWasap.onclick = ()=> {
      const text = encodeURIComponent('Ù‡Ø°Ø§ ØªÙ‚Ø¯Ù‘Ù…ÙŠ ÙÙŠ Ø­ÙØ¸ Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† â€” Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡\n');
      const whatsappUrl = `https://wa.me/?text=${text}`;
      window.open(whatsappUrl, '_blank');
    };
    shareFb.onclick = ()=> {
      const text = encodeURIComponent('ØªÙ‚Ø¯Ù‘Ù…ÙŠ ÙÙŠ Ø­ÙØ¸ Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† â€” Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡');
      // Facebook share via sharer requires URL â€” so we open FB share dialog to let user attach image manually
      window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(location.href) + '&quote=' + text, '_blank');
    };
    // direct save opens the image
    shareDirect.onclick = ()=> { window.open(url, '_blank'); };
  } catch(err){
    console.error(err);
    shareStatus.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø©: ' + (err.message||err);
  }
}

/* share modal handlers */
btnShare.addEventListener('click', ()=> {
  shareStatus.textContent = '';
  shareModal.style.display = 'flex';
});
shareClose.addEventListener('click', ()=> { shareModal.style.display='none'; });
shareWasap.addEventListener('click', async ()=> { await shareProgressAsImage(); });
shareFb.addEventListener('click', async ()=> { await shareProgressAsImage(); });
shareDirect.addEventListener('click', async ()=> { await shareProgressAsImage(); });
shareCopy.addEventListener('click', async ()=> {
  shareStatus.textContent = '';
  try{
    const svgRoot = heartWrap.querySelector('svg');
    const blob = await svgToPngBlob(svgRoot, 2);
    await navigator.clipboard.write([ new ClipboardItem({ "image/png": blob }) ]);
    shareStatus.textContent = 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© â€” Ø§Ù„ØµÙ‚Ù‡Ø§ Ø§Ù„Ø¢Ù†.';
  }catch(e){ console.error(e); shareStatus.textContent = 'Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© ØºÙŠØ± Ù…ØªÙˆÙØ± Ø£Ùˆ ÙØ´Ù„.'; }
});

/* start */
loadAndInjectSVG();
</script>
</body>
</html>
